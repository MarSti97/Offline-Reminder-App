name: Build (macOS + Windows)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

jobs:
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pytest

      - name: Run tests
        run: |
          python -m pytest -q

  build-macos:
    name: Build macOS .app
    runs-on: macos-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller

      - name: Ensure .icns icon exists (generate from tray.png if missing)
        run: |
          if [ ! -f "app/assets/tray.icns" ]; then
            echo "tray.icns not found, generating from app/assets/tray.png..."
            mkdir -p build/icon.iconset
            sips -z 16 16     app/assets/tray.png --out build/icon.iconset/icon_16x16.png
            sips -z 32 32     app/assets/tray.png --out build/icon.iconset/icon_16x16@2x.png
            sips -z 32 32     app/assets/tray.png --out build/icon.iconset/icon_32x32.png
            sips -z 64 64     app/assets/tray.png --out build/icon.iconset/icon_32x32@2x.png
            sips -z 128 128   app/assets/tray.png --out build/icon.iconset/icon_128x128.png
            sips -z 256 256   app/assets/tray.png --out build/icon.iconset/icon_128x128@2x.png
            sips -z 256 256   app/assets/tray.png --out build/icon.iconset/icon_256x256.png
            sips -z 512 512   app/assets/tray.png --out build/icon.iconset/icon_256x256@2x.png
            sips -z 512 512   app/assets/tray.png --out build/icon.iconset/icon_512x512.png
            cp app/assets/tray.png build/icon.iconset/icon_512x512@2x.png
            iconutil -c icns build/icon.iconset -o app/assets/tray.icns
          fi

      - name: Build with PyInstaller (macOS)
        run: |
          python -m PyInstaller \
            --windowed \
            --name OfflineReminder \
            --icon app/assets/tray.icns \
            --osx-bundle-identifier com.example.offlinereminder \
            --add-data "app/assets:assets" \
            run.py

      - name: Zip .app
        run: |
          ditto -c -k --sequesterRsrc --keepParent dist/OfflineReminder.app OfflineReminder-mac.zip

      - uses: actions/upload-artifact@v4
        with:
          name: OfflineReminder-mac
          path: OfflineReminder-mac.zip

  build-windows:
    name: Build Windows .exe
    runs-on: windows-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller pillow

      - name: Ensure .ico icon exists (generate from tray.png if missing)
        shell: pwsh
        run: |
          if (!(Test-Path "app\assets\tray.ico")) {
            Write-Host "tray.ico not found, generating from app/assets/tray.png..."
            python -c "from PIL import Image; img=Image.open('app/assets/tray.png').convert('RGBA'); sizes=[(16,16),(24,24),(32,32),(48,48),(64,64),(128,128),(256,256)]; img.save('app/assets/tray.ico', sizes=sizes); print('Wrote app/assets/tray.ico')"
          } else {
            Write-Host "tray.ico already exists."
          }

      - name: Build with PyInstaller (Windows)
        shell: pwsh
        run: |
          python -m PyInstaller `
            --noconsole `
            --name OfflineReminder `
            --icon app\assets\tray.ico `
            --add-data "app\assets;app\assets" `
            run.py

      - name: Zip dist folder
        shell: pwsh
        run: |
          Compress-Archive -Path dist\OfflineReminder\* -DestinationPath OfflineReminder-win.zip

      - uses: actions/upload-artifact@v4
        with:
          name: OfflineReminder-win
          path: OfflineReminder-win.zip